#!/bin/bash
DIR="$HOME/bin"
cd

######### FUNCTIONS #########
installation(){

    sudo apt install \
    \
    lsb-release jq unzip lsb-release vim rename ntpdate man hashcat awscli make \
    \
    golang ruby-full build-essential chromium \
    \
    metasploit-framework nmap sqlmap masscan dnsenum nikto  whatweb eyewitness sublist3r wpscan dirb beef-xss theharvester ldnsutils mitmproxy \
    \
    wordlists payloadsallthethings seclists wfuzz cewl \
    \
    dex2jar jd-gui \
    \
    libffi-dev libcurl4-openssl-dev libssl-dev libxml2-dev libxslt1-dev zlib1g-dev \
    \
    python3-pip python3-jsbeautifier python3-tldextract python3-termcolor python3-setuptools python3-dev \
    \

    #pip install safeurl argparse 

    # install manual: recon-ng fierce 
    # install verified: set 
    # python2: dnsrecon knockpy 
    # wifi: fern-wifi-cracker

    # create folders in ~/
    mkdir -p ~/bin ~/output
    ln -s ~/pentest/config
    ln -s ~/pentest/projects
}

binarios(){
    while read -r line || [ -n "$line" ]
    do
        asset=$(curl -S https://api.github.com/repos/${line}/releases|jq -r '.[0].assets[]|select(.name|test("linux_amd64"))')
        wget $(echo $asset | jq -r '.browser_download_url') -P /tmp/
        zip=$(echo $asset |jq -r '.name')
        file=${zip%%_*}
        unzip -juo /tmp/$zip "*$file" -d ~/bin
        rm -f /tmp/$zip*      
    done < ~/pentest/install/data/binarios.txt
}

profile(){
    if [ -f ~/.bash_aliases ]
    then
        #TODO: diff files
        cat ~/pentest/install/data/bash_aliases > ~/.bash_aliases
    else
        cat ~/pentest/install/data/bash_aliases > ~/.bash_aliases
    fi
    source ~/.bash_aliases
    source ~/.profile
}

gitremote(){
    for f in $HOME/pentest/install/data/git*.txt
    do
        file=$(basename $f)
        dir=${file:4:-4}
        echo $dir
        if [ -d $HOME/$dir ]
        then
            # git pull or clone
            while read -r line || [ -n "$line" ]
            do
                cd $HOME/$dir
                gdir=${line##*/}

                if [ -d ${gdir::-4} ]
                then
                    echo git pull $line
                    git pull $line
                else
                    echo git clone $line
                    git clone $line
                fi
            done < $f
        else
            # git clone
            mkdir $HOME/$dir
            cd $HOME/$dir

            while read -r line || [ -n "$line" ]
            do
                git clone $line
            done < $f
        fi
    done
    cd
}

gitToolsLinks(){
    # massdns
    cd ~/tools/massdns
    make
    cd ~/bin
    ln -s ~/tools/massdns/bin/massdns
    # subfinder gobuster
    go get github.com/subfinder/subfinder
    go get github.com/OJ/gobuster
    ln -s ~/go/bin/subfinder
    ln -s ~/go/bin/gobuster
    # subbrute dirsearch
    ln -s ~/tools/subbrute/subbrute.py
    ln -s ~/tools/dirsearch/dirsearch.py
    # fierce
    ln -s ~/tools/fierce/fierce/fierce.py
    # altdns
    #pip install py-altdns
    # 
    ln -s ~/tools/altdns/words.txt altdns230.txt
    ln -s ~/tools/massdns/lists/names.txt
    cd
}

########## INICIO ##########
sudo apt update
sudo apt upgrade -y
sudo apt dist-upgrade -y

cd ~/pentest

if [ -d "$DIR" ]
then
    # update
    binarios
    gitremote
    profile
else
    # install
    installation
    binarios
    gitremote
    gitToolsLinks
    profile
fi

sudo apt -y autoremove
sudo ntpdate -u 0.pool.ntp.org
sudo service postgresql restart
sudo service mysql restart
sudo service apache2 restart
sudo service docker start

exit 0
#!/bin/bash

CONFIG="$HOME/config"
TOOLS="$HOME/tools"
RESOLVERS="$CONFIG/resolvers.txt"
#WL_DNS="/usr/share/seclists/Discovery/DNS/namelist.txt"
WL_DNS="/usr/share/seclists/Discovery/DNS/dns-Jhaddix.txt"
#WL_DNS="$HOME/wordlists/names.txt"
WL_ALT="$HOME/wordlists/altdns230.txt"
WL_COMMONSPEAK="$HOME/wordlists/commonspeak2-wordlists/subdomains/subdomains.txt"
DOUTPUT="$HOME/output"
FDOMAINS="$HOME/config/domains.txt"
FNAME=$(date +"%Y-%m-%d")
inicio=$(date)
fin=""

enumeration(){
  echo "recon subdomains of $DOMAIN"
  #PASSIVE
  sublist3r -d $DOMAIN -t 10 -v -o $FSUBDOMAINS
  amass enum -passive -config ~/config/amass.ini -d $DOMAIN -rf ~/config/resolvers.txt >> $FSUBDOMAINS
  subfinder --silent --rL $RESOLVERS -d $DOMAIN >> $FSUBDOMAINS
  # Subdomains from Rapid7 FDNS
  python3 $HOME/pentest/commonspeak2.py $DOMAIN >> $FSUBDOMAINS
  curl -s https://certspotter.com/api/v0/certs\?domain\=$DOMAIN | jq '.[].dns_names[]' | sed 's/\"//g' | sed 's/\*\.//g' | sort -u | grep $DOMAIN >> $FSUBDOMAINS
  $HOME/tools/massdns/scripts/subbrute.py $WL_DNS $DOMAIN >> $FSUBDOMAINS
  $HOME/tools/massdns/scripts/ct.py $DOMAIN >> $FSUBDOMAINS

  sort -u $FSUBDOMAINS -o $FSUBDOMAINS

  massdns -s 1000 -o S -q -r $RESOLVERS $FSUBDOMAINS -w $FRESOLVED

  sed 's/A.*//' $FRESOLVED | sed 's/CN.*//' | sed 's/\..$//' | sort -u -o $FRESOLVED
  
  altdns -i $FRESOLVED -o $FALTERATIONS -w $WL_ALT
  massdns -s 1000 -o S -q -r $RESOLVERS $FALTERATIONS >> $FRESOLVED
  sed 's/A.*//' $FRESOLVED | sed 's/CN.*//' | sed 's/\..$//' | sort -u -o $FRESOLVED
  exit 0
}


hostalive(){
  echo "hostalive subdomain of $DOMAIN"
  while read SUBDOMAIN || [[ -n "$SUBDOMAIN" ]]
  do
    if [ $(curl --write-out %{http_code} --silent --output /dev/null -m 5 http://$SUBDOMAIN) = 000 ] || [$(curl --write-out %{http_code} --silent --output /dev/null -m 5 -k https://$SUBDOMAIN) = 000 ]
    then
      echo $SUBDOMAIN >> $FUNREACHABLE
    else
      echo $SUBDOMAIN >> $FHOSTLIVE
    fi
  done < $FRESOLVED
}

screenshot(){
  echo "taking a screenshot responsive of $DOMAIN"
  python3 ~/tools/webscreenshot/webscreenshot.py -o $DSCREENSHOTS -i $FHOSTLIVE --timeout=10 -m
  cd $DSCREENSHOTS
  rename 's/_/-/g' -- *
  cd $DRECON
}

dirsearcher(){
  echo "dirsearch subdomains responsive of $DOMAIN"
  while read SUBDOMAIN || [[ -n "$SUBDOMAIN" ]]
  do
    sleep 1
    dirsearch.py -e php,asp,aspx,jsp,html,zip,jar,sql -u $SUBDOMAIN
    report $SUBDOMAIN
    sleep 1
  done < $FHOSTLIVE
}

report(){
  echo "report subdomains responsive of $DOMAIN"
  REPORT_SUBDOMAIN="$DREPORTS/$SUBDOMAIN.html"
  touch $REPORT_SUBDOMAIN
  echo "<title> report for $SUBDOMAIN </title>" >> $REPORT_SUBDOMAIN
  echo "<html>" >> $REPORT_SUBDOMAIN
  echo "<head>" >> $REPORT_SUBDOMAIN
  echo "<link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Mina\" rel=\"stylesheet\">" >> $REPORT_SUBDOMAIN
  echo "</head>" >> $REPORT_SUBDOMAIN
  echo "<body><meta charset=\"utf-8\"> <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\"> <link rel=\"stylesheet\" href=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css\"> <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js\"></script> <script src=\"https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js\"></script></body>" >> $REPORT_SUBDOMAIN
  echo "<div class=\"jumbotron text-center\"><h1> Recon Report for <a/href=\"https://$SUBDOMAIN\">$SUBDOMAIN</a></h1>" >> $REPORT_SUBDOMAIN
  echo "<p> Generated by <a/href=\"https://github.com/nahamsec/lazyrecon\"> LazyRecon</a> on $(date) </p></div>" >> $REPORT_SUBDOMAIN
  
  
  echo "   <div clsas=\"row\">" >> $REPORT_SUBDOMAIN
  echo "     <div class=\"col-sm-6\">" >> $REPORT_SUBDOMAIN
  echo "     <div style=\"font-family: 'Mina', serif;\"><h2>Dirsearch</h2></div>" >> $REPORT_SUBDOMAIN
  echo "<pre>" >> $REPORT_SUBDOMAIN
  
  cat ~/tools/dirsearch/reports/$SUBDOMAIN/* | while read rline; do echo "$rline" >> $REPORT_SUBDOMAIN
  done
  
  echo "</pre>   </div>" >> $REPORT_SUBDOMAIN
  
  echo "     <div class=\"col-sm-6\">" >> $REPORT_SUBDOMAIN
  echo "<div style=\"font-family: 'Mina', serif;\"><h2>Screeshot</h2></div>" >> $REPORT_SUBDOMAIN
  echo "<pre>" >> $REPORT_SUBDOMAIN
  echo "Port 80                              Port 443" >> $REPORT_SUBDOMAIN
  echo "<img/src=\"../screenshots/http-$SUBDOMAIN-80.png\" style=\"max-width: 500px;\"> <img/src=\"../screenshots/https-$SUBDOMAIN-443.png\" style=\"max-width: 500px;\"> <br>" >> $REPORT_SUBDOMAIN
  echo "</pre>" >> $REPORT_SUBDOMAIN
  
  echo "<div style=\"font-family: 'Mina', serif;\"><h2>Dig Info</h2></div>" >> $REPORT_SUBDOMAIN
  echo "<pre>" >> $REPORT_SUBDOMAIN
  dig $SUBDOMAIN >> $REPORT_SUBDOMAIN
  echo "</pre>" >> $REPORT_SUBDOMAIN
  
  echo "<div style=\"font-family: 'Mina', serif;\"><h2>Host Info</h1></div>" >> $REPORT_SUBDOMAIN
  echo "<pre>" >> $REPORT_SUBDOMAIN
  host $SUBDOMAIN >> $REPORT_SUBDOMAIN
  echo "</pre>" >> $REPORT_SUBDOMAIN
  
  echo "<div style=\"font-family: 'Mina', serif;\"><h2>Response Header</h1></div>" >> $REPORT_SUBDOMAIN
  echo "<pre>" >> $REPORT_SUBDOMAIN
  curl -sSL -D - $SUBDOMAIN  -o /dev/null >> $REPORT_SUBDOMAIN
  echo "</pre>" >> $REPORT_SUBDOMAIN
  
  echo "<div style=\"font-family: 'Mina', serif;\"><h1>Nmap Results</h1></div>" >> $REPORT_SUBDOMAIN
  echo "<pre>" >> $REPORT_SUBDOMAIN
  echo "nmap -sV -T3 -Pn -p3868,3366,8443,8080,9443,9091,3000,8000,5900,8081,6000,10000,8181,3306,5000,4000,8888,5432,15672,9999,161,4044,7077,4040,9000,8089,443,7447,7080,8880,8983,5673,7443" >> $REPORT_SUBDOMAIN
  nmap -sV -T3 -Pn -p3868,3366,8443,8080,9443,9091,3000,8000,5900,8081,6000,10000,8181,3306,5000,4000,8888,5432,15672,9999,161,4044,7077,4040,9000,8089,443,7447,7080,8880,8983,5673,7443 $SUBDOMAIN >> $REPORT_SUBDOMAIN
  echo "</pre></div>" >> $REPORT_SUBDOMAIN
  echo "</html>" >> $REPORT_SUBDOMAIN
}

main (){
  while read -r DOMAIN || [[ -n "$DOMAIN" ]]
  do
    DRECON="$DOUTPUT/$DOMAIN/$FNAME"
    DREPORTS="$DRECON/reports"
    DSCREENSHOTS="$DRECON/screenshots"
    FSUBDOMAINS="$DRECON/subdomains.txt"
    FRESOLVED="$DRECON/resolved.txt"
    FALTERATIONS="$DRECON/alterations.txt"
    FHOSTLIVE="$DRECON/hostlive.txt"
    FUNREACHABLE="$DRECON/unreachable.txt"

    mkdir -p $DREPORTS
    mkdir -p $DSCREENSHOTS
    touch $FSUBDOMAINS
    touch $FRESOLVED
    touch $FUNREACHABLE
    touch $FHOSTLIVE
    cd $DRECON
    
    enumeration 1> >(tee -a $DRECON/$DOMAIN.log) 2> >(tee -a $DRECON/error.log)
    hostalive 1> >(tee -a $DRECON/$DOMAIN.log) 2> >(tee -a $DRECON/error.log)
    screenshot 1> >(tee -a $DRECON/$DOMAIN.log) 2> >(tee -a $DRECON/error.log)
    dirsearcher 1> >(tee -a $DRECON/$DOMAIN.log) 2> >(tee -a $DRECON/error.log)
    
  done < $FDOMAINS
  
}

echo $FNAME >> $DOUTPUT/recon.log
echo $FNAME >> $DOUTPUT/error.log
main 1> >(tee -a $DOUTPUT/recon.log) 2> >(tee -a $DOUTPUT/error.log)

exit 0